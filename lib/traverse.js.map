{"version":3,"sources":["../src/traverse.js"],"names":["_traverseNextNode","$node","Observable","create","$o","subscribe","next","node","nextNode","complete","error","err","_traverseVNodeNext","traverse","cx","ensureDoc","bind","__vnode_context","vnode","type","parent","indexInParent","depth","count","Close","first","undefined"],"mappings":"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","sourcesContent":["/**\r\n * Traversal\r\n * @module traverse\r\n */\r\n\r\nimport { Observable } from \"rxjs\";\r\n\r\nimport { Close } from \"./vnode\";\r\n\r\nimport { ensureDoc } from \"./doc\";\r\n\r\n/**\r\n * Next-sibling based traversal\r\n * @private\r\n * @param  {Observable} $node [description]\r\n * @return {Observable}       [description]\r\n */\r\nconst _traverseNextNode = $node => Observable.create($o => {\r\n\treturn $node.subscribe({\r\n\t\tnext(node) {\r\n\t\t\twhile (node) {\r\n\t\t\t\t$o.next(node);\r\n\t\t\t\tnode = nextNode(node);\r\n\t\t\t}\r\n\r\n\t\t\t$o.complete();\r\n\t\t},\r\n\t\terror(err) {\r\n\t\t\t$o.error(err);\r\n\t\t}\r\n\t});\r\n});\r\n\r\n/**\r\n * Used for closer-aware contexts (e.g. linked list)\r\n * @private\r\n * @param  {Observable} $node [description]\r\n * @return {Observable}       [description]\r\n */\r\nconst _traverseVNodeNext = $node => Observable.create($o => {\r\n\treturn $node.subscribe({\r\n\t\tnext(node) {\r\n\t\t\twhile (node) {\r\n\t\t\t\t$o.next(node);\r\n\t\t\t\tnode = node.next(node);\r\n\t\t\t}\r\n\r\n\t\t\t$o.complete();\r\n\t\t},\r\n\t\terror(err) {\r\n\t\t\t$o.error(err);\r\n\t\t}\r\n\t});\r\n});\r\n\r\n\r\n/**\r\n * Traverses a document in depth-first (AKA \"document\") order\r\n * In addition to every node in the document, a special `Close` node is emitted after every traversed branch.\r\n * @param  {any} $node  (faux) VNode, Observable or any node constructed within the bound context\r\n * @return {Observable} An Observable stream emitting VNodes\r\n */\r\nexport function traverse($node) {\r\n\tvar cx = this;\r\n\t$node = ensureDoc.bind(cx)($node);\r\n\treturn cx.__vnode_context == \"triply\" ? _traverseVNodeNext($node) : _traverseNextNode($node);\r\n}\r\n\r\nexport default traverse;\r\n\r\n// NOTE nextNode is never eligable for seqs, but it may be exposed for other purposes\r\nfunction nextNode(vnode /* VNode */) {\r\n\tlet type = vnode.type,\r\n\t\tnode = vnode.node,\r\n\t\tparent = vnode.parent,\r\n\t\tindexInParent = vnode.indexInParent || 1;\r\n\tvar depth = vnode.depth || 0;\r\n\t// FIXME improve check\r\n\tif (type != 17 && (type == 1 || type == 5 || type == 6 || type == 14 || type == 15) && vnode.count() === 0) {\r\n\t\treturn new Close(vnode);\r\n\t}\r\n\tif (type != 17 && vnode.count() > 0) {\r\n\t\t// if we can still go down, return firstChild\r\n\t\tdepth++;\r\n\t\tindexInParent = 1;\r\n\t\tparent = vnode;\r\n\t\tnode = vnode.first();\r\n\t\t// TODO handle arrays\r\n\t\tvnode = parent.vnode(node, parent, depth, indexInParent);\r\n\t\t//console.log(\"found first\", vnode, depth,indexInParent, parent.count());\r\n\t\treturn vnode;\r\n\t} else {\r\n\t\t// emergency exit\r\n\t\tif (!parent) return;\r\n\t\t// if there are no more children, return a 'Close' to indicate a close\r\n\t\t// it means we have to continue one or more steps up the path\r\n\t\tif (parent.count() == indexInParent) {\r\n\t\t\t//node = parent;\r\n\t\t\tdepth--;\r\n\t\t\tvnode = vnode.parent;\r\n\t\t\tif (depth === 0 || !vnode) return;\r\n\t\t\tnode = vnode.node;\r\n\t\t\t//console.log(\"found step\", vnode.name, depth, indexInParent);\r\n\t\t\tvnode = new Close(vnode);\r\n\t\t\treturn vnode;\r\n\t\t} else {\r\n\t\t\t// return the next child\r\n\t\t\tindexInParent++;\r\n\t\t\tnode = parent.next(vnode);\r\n\t\t\tif (node !== undefined) {\r\n\t\t\t\tvnode = parent.vnode(node, parent, depth, indexInParent);\r\n\t\t\t\t//console.log(\"found next\", vnode.type, depth, indexInParent);\r\n\t\t\t\treturn vnode;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"],"file":"traverse.js"}