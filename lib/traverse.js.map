{"version":3,"sources":["../src/traverse.js"],"names":["traverse","$node","cx","ensureDoc","bind","Observable","create","$o","subscribe","next","node","nextNode","complete","error","err","vnode","type","parent","indexInParent","depth","count","Close","first","undefined"],"mappings":";;;;;QAMgBA,Q,GAAAA,Q;;AANhB;;AAEA;;AAEA;;AAEO,SAASA,QAAT,CAAkBC,KAAlB,EAAyB;AAC/B,KAAIC,KAAK,IAAT;AACAD,SAAQE,eAAUC,IAAV,CAAeF,EAAf,EAAmBD,KAAnB,CAAR;AACA,QAAOI,iBAAWC,MAAX,CAAkBC,MAAM;AAC9B,SAAON,MAAMO,SAAN,CAAgB;AACtBC,QAAKC,IAAL,EAAW;AACV,WAAOA,IAAP,EAAa;AACZH,QAAGE,IAAH,CAAQC,IAAR;AACAA,YAAOC,SAASD,IAAT,CAAP;AACA;AACDH,OAAGK,QAAH;AACA,IAPqB;AAQtBC,SAAMC,GAAN,EAAW;AACVP,OAAGM,KAAH,CAASC,GAAT;AACA;AAVqB,GAAhB,CAAP;AAYA,EAbM,CAAP;AAcA;;kBAEcd,Q;;AAEf;AACA;;AACA,SAASW,QAAT,CAAkBI,KAAlB,CAAwB,WAAxB,EAAqC;AACpC,KAAIC,OAAOD,MAAMC,IAAjB;AAAA,KACCN,OAAOK,MAAML,IADd;AAAA,KAECO,SAASF,MAAME,MAFhB;AAAA,KAGCC,gBAAgBH,MAAMG,aAAN,IAAuB,CAHxC;AAIA,KAAIC,QAAQJ,MAAMI,KAAN,IAAe,CAA3B;AACA;AACA,KAAIH,QAAQ,EAAR,KAAeA,QAAQ,CAAR,IAAaA,QAAQ,CAArB,IAA0BA,QAAQ,CAAlC,IAAuCA,QAAQ,EAA/C,IAAqDA,QAAQ,EAA5E,KAAmFD,MAAMK,KAAN,OAAkB,CAAzG,EAA4G;AAC3G,SAAO,IAAIC,YAAJ,CAAUN,KAAV,CAAP;AACA;AACD,KAAIC,QAAQ,EAAR,IAAcD,MAAMK,KAAN,KAAgB,CAAlC,EAAqC;AACpC;AACAD;AACAD,kBAAgB,CAAhB;AACAD,WAASF,KAAT;AACAL,SAAOK,MAAMO,KAAN,EAAP;AACA;AACAP,UAAQE,OAAOF,KAAP,CAAaL,IAAb,EAAmBO,MAAnB,EAA2BE,KAA3B,EAAkCD,aAAlC,CAAR;AACA;AACA,SAAOH,KAAP;AACA,EAVD,MAUO;AACN;AACA,MAAI,CAACE,MAAL,EAAa;AACb;AACA;AACA,MAAIA,OAAOG,KAAP,MAAkBF,aAAtB,EAAqC;AACpC;AACAC;AACAJ,WAAQA,MAAME,MAAd;AACA,OAAIE,UAAU,CAAV,IAAe,CAACJ,KAApB,EAA2B;AAC3BL,UAAOK,MAAML,IAAb;AACA;AACAK,WAAQ,IAAIM,YAAJ,CAAUN,KAAV,CAAR;AACA,UAAOA,KAAP;AACA,GATD,MASO;AACN;AACAG;AACAR,UAAOO,OAAOR,IAAP,CAAYM,KAAZ,CAAP;AACA,OAAIL,SAASa,SAAb,EAAwB;AACvBR,YAAQE,OAAOF,KAAP,CAAaL,IAAb,EAAmBO,MAAnB,EAA2BE,KAA3B,EAAkCD,aAAlC,CAAR;AACA;AACA,WAAOH,KAAP;AACA;AACD;AACD;AACD","file":"traverse.js","sourcesContent":["import { Observable } from \"rxjs\";\r\n\r\nimport { Close } from \"./vnode\";\r\n\r\nimport { ensureDoc } from \"./doc\";\r\n\r\nexport function traverse($node) {\r\n\tvar cx = this;\r\n\t$node = ensureDoc.bind(cx)($node);\r\n\treturn Observable.create($o => {\r\n\t\treturn $node.subscribe({\r\n\t\t\tnext(node) {\r\n\t\t\t\twhile (node) {\r\n\t\t\t\t\t$o.next(node);\r\n\t\t\t\t\tnode = nextNode(node);\r\n\t\t\t\t}\r\n\t\t\t\t$o.complete();\r\n\t\t\t},\r\n\t\t\terror(err) {\r\n\t\t\t\t$o.error(err);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nexport default traverse;\r\n\r\n// FIXME nextNode is never eligable for seqs, so it shouldn't be exposed\r\n// TODO write nextNode function: create observable for current node, subscribe and call nextNode\r\nfunction nextNode(vnode /* VNode */) {\r\n\tlet type = vnode.type,\r\n\t\tnode = vnode.node,\r\n\t\tparent = vnode.parent,\r\n\t\tindexInParent = vnode.indexInParent || 1;\r\n\tvar depth = vnode.depth || 0;\r\n\t// FIXME improve check\r\n\tif (type != 17 && (type == 1 || type == 5 || type == 6 || type == 14 || type == 15) && vnode.count() === 0) {\r\n\t\treturn new Close(vnode);\r\n\t}\r\n\tif (type != 17 && vnode.count() > 0) {\r\n\t\t// if we can still go down, return firstChild\r\n\t\tdepth++;\r\n\t\tindexInParent = 1;\r\n\t\tparent = vnode;\r\n\t\tnode = vnode.first();\r\n\t\t// TODO handle arrays\r\n\t\tvnode = parent.vnode(node, parent, depth, indexInParent);\r\n\t\t//console.log(\"found first\", vnode, depth,indexInParent, parent.count());\r\n\t\treturn vnode;\r\n\t} else {\r\n\t\t// emergency exit\r\n\t\tif (!parent) return;\r\n\t\t// if there are no more children, return a 'Close' to indicate a close\r\n\t\t// it means we have to continue one or more steps up the path\r\n\t\tif (parent.count() == indexInParent) {\r\n\t\t\t//node = parent;\r\n\t\t\tdepth--;\r\n\t\t\tvnode = vnode.parent;\r\n\t\t\tif (depth === 0 || !vnode) return;\r\n\t\t\tnode = vnode.node;\r\n\t\t\t//console.log(\"found step\", vnode.name, depth, indexInParent);\r\n\t\t\tvnode = new Close(vnode);\r\n\t\t\treturn vnode;\r\n\t\t} else {\r\n\t\t\t// return the next child\r\n\t\t\tindexInParent++;\r\n\t\t\tnode = parent.next(vnode);\r\n\t\t\tif (node !== undefined) {\r\n\t\t\t\tvnode = parent.vnode(node, parent, depth, indexInParent);\r\n\t\t\t\t//console.log(\"found next\", vnode.type, depth, indexInParent);\r\n\t\t\t\treturn vnode;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"]}