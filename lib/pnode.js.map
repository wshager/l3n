{"version":3,"sources":["../src/pnode.js"],"names":["getType","set","vnode","create","get","has","next","push","removeChild","cached","keys","values","finalize","count","first","last","entries","modify","stringify","toJS","ohamt","rrb","cx","__vnode_context","Value","constructor","type","name","value","$type","$name","$value","__is_Value","size","valueOf","toString","str","node","key","parent","depth","indexInParent","$key","VNode","nameOrValue","attrs","empty","beginMutation","Object","reduce","a","k","v","make","val","join","idx","kv","child","_type","removeValue","remove","endMutation","ref","undefined","insertBefore","reduceList","list","f","z","i","l","dollarRE","_elemToString","e","attrFunc","test","children","c","prettifier","docAttrFunc"],"mappings":"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","file":"pnode.js","sourcesContent":["import * as ohamt from \"ohamt\";\r\n\r\nimport * as rrb from \"rrb-vector\";\r\n\r\nimport { VNode } from \"./vnode\";\r\n\r\n//import { prettyXML } from \"./pretty\";\r\n\r\nimport { isBranch } from \"./convert\";\r\n\r\nimport { serialize } from \"./doctype\";\r\n\r\n// import self!\r\nimport * as cx from \"./pnode\";\r\n\r\n// helpers ---------------\r\nexport const __vnode_context = \"pnode\";\r\n\r\n/**\r\n * immutable value wrapper\r\n * this differs much from inode, because we would infer a type there,\r\n * but here we have a typed value or name/value pair\r\n * @param       {[type]} type  [description]\r\n * @param       {[type]} name  [description]\r\n * @param       {[type]} value [description]\r\n * @constructor\r\n */\r\nclass Value {\r\n\tconstructor(type, name, value) {\r\n\t\tthis.$type = type;\r\n\t\tthis.$name = name;\r\n\t\tthis.$value = value;\r\n\t\tthis.__is_Value = true;\r\n\t\tthis.size = 0;\r\n\t}\r\n\tget(){\r\n\t\treturn this.$value;\r\n\t}\r\n\t// immutable, so type can't change\r\n\tset(value) {\r\n\t\treturn new Value(this.$type,this.$name,value);\r\n\t}\r\n\tvalues() {\r\n\t\t// attr vs typed string vs primitive?\r\n\t\treturn [this.$value];\r\n\t}\r\n\tcount(){\r\n\t\treturn this.size;\r\n\t}\r\n\tvalueOf() {\r\n\t\treturn this.$value;\r\n\t}\r\n\ttoString() {\r\n\t\tvar str = this.$value + \"\";\r\n\t\t//if(this.$type == 3 && json) return \"\\\"\"+str+\"\\\"\";\r\n\t\treturn str;\r\n\t}\r\n\ttoJS() {\r\n\t\treturn this.valueOf();\r\n\t}\r\n}\r\n\r\nexport function getType(node){\r\n\treturn node.$type;\r\n}\r\n\r\n// -----------------------\r\n\r\nexport function set(node, key, value/*, type*/){\r\n\t//type = type || getType(node);\r\n\treturn node.set(key,value);\r\n}\r\n\r\nexport function vnode(node, parent, depth, indexInParent, type){\r\n\ttype = type || getType(node);\r\n\tlet name,\r\n\t\tkey = node.$key,\r\n\t\tvalue;\r\n\tif (type == 1 || type == 9 || type == 11 || type == 14) {\r\n\t\tname = node.get(\"$name\");\r\n\t} else if (type == 2) {\r\n\t\tname = node.$name;\r\n\t\tvalue = node.$value;\r\n\t\t// this ensures pairs are iterated as values (name != key)\r\n\t\tif (node.$key) {\r\n\t\t\tnode = node.$value;\r\n\t\t\ttype = getType(node);\r\n\t\t}\r\n\t} else if (type == 7) {\r\n\t\tvalue = node.$value;\r\n\t} else if (type == 8) {\r\n\t\tvalue = node.$value;\r\n\t} else if (type == 3 || type == 12) {\r\n\t\tvalue = node;\r\n\t} else if (type == 15) {\r\n\t\tname = \"quote\";\r\n\t}\r\n\treturn new VNode(cx, node, type,\r\n\t\tname, key, value, parent, depth, indexInParent);\r\n}\r\n\r\nexport function create(type, nameOrValue, attrs = {}) {\r\n\tif(type == 5) {\r\n\t\tconst node = rrb.empty.beginMutation();\r\n\t\tnode.$type = type;\r\n\t\treturn node;\r\n\t} else if(isBranch(type)) {\r\n\t\tconst node = Object.entries(attrs).reduce((a,[k,v]) => a.set(k,v),ohamt.make().beginMutation());\r\n\t\tnode.$type = type;\r\n\t\tif(type == 6) {\r\n\t\t\treturn node;\r\n\t\t} else if(type == 1 || type == 9 || type == 11) {\r\n\t\t\treturn node.set(\"$name\",nameOrValue).set(\"$children\",rrb.empty.beginMutation());\r\n\t\t} else if(type == 14) {\r\n\t\t\treturn node.set(\"$name\",nameOrValue).set(\"$args\",rrb.empty.beginMutation());\r\n\t\t} else if(type == 15) {\r\n\t\t\treturn node.set(\"$args\",rrb.empty.beginMutation());\r\n\t\t}\r\n\t} else if(type == 2) {\r\n\t\treturn new Value(2,nameOrValue);\r\n\t} else {\r\n\t\tconst val = type == 7 ? nameOrValue.join(\" \") : type == 10 ? serialize(...nameOrValue) : nameOrValue;\r\n\t\treturn new Value(type,null,val);\r\n\t}\r\n}\r\n\r\nexport function get(node, idx){\r\n\treturn node.get(idx);\r\n}\r\n\r\nexport function has(node,idx){\r\n\treturn node.has(idx);\r\n}\r\n\r\nexport function next(node,vnode/*,type*/){\r\n\t//type = type || getType(node);\r\n\tconst next = node.next(vnode.name,vnode.node);\r\n\treturn next;\r\n}\r\n\r\nexport function push(node, kv, type){\r\n\ttype = type || getType(node);\r\n\tif(type == 1 || type == 9 || type == 11){\r\n\t\t// children is a multimap\r\n\t\treturn node.set(\"$children\",node.get(\"$children\").push(kv[1]));\r\n\t} else {\r\n\t\tconst [k,v] = kv;\r\n\t\tif(type == 5) {\r\n\t\t\treturn node.push(v);\r\n\t\t} else if(type == 6){\r\n\t\t\treturn node.set(k,v);\r\n\t\t} else if(type == 14 || type == 15) {\r\n\t\t\tnode.set(\"$args\",node.get(\"$args\").push(v));\r\n\t\t}\r\n\t}\r\n\treturn node;\r\n}\r\n\r\nexport function removeChild(node,child,type){\r\n\ttype = type || node._type;\r\n\tvar key = child.name, val = child.node;\r\n\tif(type == 1 || type == 9 || type == 11){\r\n\t\treturn node.set(\"$children\",node.get(\"$children\").removeValue(key, val));\r\n\t} else if(type == 5 || type == 6){\r\n\t\treturn node.remove(key);\r\n\t}\r\n\treturn node;\r\n}\r\n\r\nexport function cached(){\r\n\t// TODO?\r\n}\r\n\r\nexport function keys(node){\r\n\treturn node.keys();\r\n}\r\n\r\nexport function values(node){\r\n\treturn node.values();\r\n}\r\n\r\nexport function finalize(node){\r\n\treturn node.endMutation();\r\n}\r\n\r\nexport function count(node, type){\r\n\ttype = type || getType(node);\r\n\treturn type == 1 || type == 9 || type == 11 ? node.get(\"$children\").count() : node.count();\r\n}\r\n\r\nexport function first(node,type){\r\n\ttype = type || getType(node);\r\n\tconst first = type == 1 || type == 9 || type == 11 ? node.get(\"$children\").first() : node.first();\r\n\treturn first;\r\n}\r\n\r\nexport function last(node){\r\n\treturn node.last();\r\n}\r\n\r\nexport function entries(node){\r\n\treturn node.entries();\r\n}\r\n\r\nexport function modify(node,vnode,ref,type) {\r\n\ttype = type || getType(node);\r\n\tif(type == 1 || type == 9 || type == 11){\r\n\t\tif(vnode.type == 2) {\r\n\t\t\treturn node.set(vnode.name,vnode.node.$value + \"\");\r\n\t\t} else if (ref !== undefined) {\r\n\t\t\treturn node.set(\"$children\",node.get(\"$children\").insertBefore([ref.name,ref.node],[vnode.name,vnode.node]));\r\n\t\t} else {\r\n\t\t\t// FIXME check the parent type\r\n\t\t\treturn node.set(\"$children\",node.get(\"$children\").push(vnode.node));\r\n\t\t}\r\n\t} else if(type == 2) {\r\n\t\treturn node.set(vnode.node);\r\n\t} else if(type == 5) {\r\n\t\tif (ref !== undefined) {\r\n\t\t\treturn node.insertBefore(ref,vnode.node);\r\n\t\t} else {\r\n\t\t\treturn node.push(vnode.node);\r\n\t\t}\r\n\t} else if(type == 6) {\r\n\t\treturn node.set(vnode.name,vnode.node.$value);\r\n\t}\r\n\treturn node;\r\n}\r\n\r\nconst reduceList = (list, f, z) => {\r\n\tfor(let i = 0, l = list.size; i < l; i++){\r\n\t\tz = f(z,list.get(i),i,list);\r\n\t}\r\n\treturn z;\r\n};\r\n\r\nconst dollarRE = /^\\$/;\r\n\r\nfunction _elemToString(e){\r\n\tconst attrFunc = (z,v,k) => {\r\n\t\tif(dollarRE.test(k)) return z;\r\n\t\treturn z += \" \"+k+\"=\\\"\"+v+\"\\\"\";\r\n\t};\r\n\tconst name = e.get(\"$name\");\r\n\tlet str = \"<\"+name;\r\n\t// TODO QName\r\n\t//let ns = {};\r\n\t//if(ns) str += \" xmlns\" + (ns.prefix ? \":\" + ns.prefix : \"\") + \"=\\\"\" + ns.uri + \"\\\"\";\r\n\tstr = e.reduce(attrFunc,str);\r\n\tconst children = e.get(\"$children\");\r\n\tif(children.size){\r\n\t\tstr += \">\";\r\n\t\tstr = reduceList(children,(a,c) => a + stringify(c),str);\r\n\t\tstr += \"</\"+name+\">\";\r\n\t} else {\r\n\t\tstr += \"/>\";\r\n\t}\r\n\treturn str;\r\n}\r\n\r\nexport function stringify(node,type,prettifier){\r\n\tvar str = \"\";\r\n\ttype = type || getType(node);\r\n\tconst docAttrFunc = (z,v,k) => {\r\n\t\tif(k == \"DOCTYPE\") return z + \"<!\"+k+\" \"+v+\">\";\r\n\t\treturn z;\r\n\t};\r\n\t//const objFunc = (kv) => \"\\\"\"+kv[0]+\"\\\":\"+kv[1].toString(false,true);\r\n\tif(type == 1) {\r\n\t\tstr += _elemToString(node);\r\n\t} else if(type == 2) {\r\n\t\tstr += \"<l3:a name=\\\"\" + node.$name + \"\\\">\" + stringify(node.$value) + \"</l3:a>\";\r\n\t} else if(type == 5) {\r\n\t\tconst val = reduceList(node,(a,c) => a + stringify(c),\"\");\r\n\t\tstr += \"<l3:l\" + (val ? \">\" + val + \"</l3:l>\" : \"/>\");\r\n\t} else  if(type == 6){\r\n\t\tconst val = node.reduce((a,v,k) => {\r\n\t\t\treturn a + stringify(new Value(2,k,v));\r\n\t\t},\"\");\r\n\t\tstr += \"<l3:m\" + (val ? \">\" + val + \"</l3:m>\" : \"/>\");\r\n\t} else if(type == 14 || type == 15) {\r\n\t\tconst val = reduceList(node.get(\"$args\"),(a,c) => a + stringify(c),\"\");\r\n\t\tif(type == 14) {\r\n\t\t\tstr += \"<l3:f name=\\\"\" + node.get(\"$name\") + \"\\\"\" + (val ? \">\" + val + \"</l3:f>\" : \"/>\");\r\n\t\t} else {\r\n\t\t\tstr += \"<l3:q\" + (val ? \">\" + val + \"</l3:q>\" : \"/>\");\r\n\t\t}\r\n\t} else if(type == 9 || type == 11){\r\n\t\tstr = node.reduce(docAttrFunc,str);\r\n\t\tstr = reduceList(node.get(\"$children\"),(a,c) => a + stringify(c),str);\r\n\t} else {\r\n\t\tstr = node.toString();\r\n\t}\r\n\treturn prettifier ? prettifier(str) : str;\r\n}\r\n\r\n\r\nexport function toJS(node){\r\n\treturn node.toJS();\r\n}\r\n"]}